{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}


{% block title %}Ticket #{{ ticket.ticket_number }} - Huduma Center{% endblock %}

{% block content %}
<div class="container">
  <!-- Ticket Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
      Ticket #{{ ticket.ticket_number }}
      <span class="badge 
        {% if ticket.status == 'P' %}bg-warning
        {% elif ticket.status == 'G' %}bg-info
        {% else %}bg-success{% endif %}">
        {{ ticket.get_status_display }}
      </span>
    </h1>
    {% if user.role == 'S' or user.role == 'A' %}
      <a href="{% url 'staff-dashboard' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
      </a>
    {% else %}
      <a href="{% url 'ticket-list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> My Tickets
      </a>
    {% endif %}
  </div>

  <!-- Main Ticket Info -->
  <div class="card shadow mb-4">
    <div class="card-header py-3 {% if ticket.priority == 'H' %}bg-danger text-white{% else %}bg-primary text-white{% endif %}">
      <h5 class="mb-0">
        <i class="fas fa-ticket-alt me-2"></i>
        {{ ticket.service.name }}
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6>Service Details</h6>
          <p><strong>Department:</strong> {{ ticket.service.department }}</p>
          <p><strong>Description:</strong> {{ ticket.service.description }}</p>
          <h6 class="mt-4">Timeline</h6>
          <ul>
            <li><strong>Created:</strong> {{ ticket.created_at|date:"M d, Y H:i" }}</li>
            {% if ticket.processing_start %}
            <li><strong>Processing Started:</strong> {{ ticket.processing_start|date:"M d, Y H:i" }}</li>
            {% endif %}
            {% if ticket.completed_at %}
            <li><strong>Completed:</strong> {{ ticket.completed_at|date:"M d, Y H:i" }}</li>
            {% endif %}
          </ul>
        </div>
        <div class="col-md-6">
          <h6>Customer Info</h6>
          <p><strong>Name:</strong> {{ ticket.user.get_full_name|default:ticket.user.username }}</p>
          <p><strong>ID:</strong> {{ ticket.user.id_number }}</p>
          <p><strong>Email:</strong> {{ ticket.user.email }}</p>
          <p><strong>Phone:</strong> {{ ticket.user.phone }}</p>
          <h6 class="mt-4">Progress</h6>
          <div class="progress mb-2">
            <div class="progress-bar 
              {% if ticket.status == 'P' %}bg-warning
              {% elif ticket.status == 'G' %}bg-info progress-bar-striped progress-bar-animated
              {% else %}bg-success{% endif %}" 
              style="width: {{ ticket.progress }}%">
              {{ ticket.progress }}%
            </div>
          </div>
          <small class="text-muted">Wait time: {{ ticket.wait_time }} mins</small>
        </div>
      </div>

      <!-- Staff Actions -->
      {% if user.role == 'S' or user.role == 'A' %}
      <form method="post" class="mt-4 border-top pt-3">
        {% csrf_token %}
        <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
        {% if ticket.status == 'P' %}
          <button name="action" value="process" class="btn btn-primary me-2">
            <i class="fas fa-play"></i> Start Processing
          </button>
        {% elif ticket.status == 'G' %}
          <button name="action" value="complete" class="btn btn-success me-2">
            <i class="fas fa-check"></i> Mark Complete
          </button>
        {% endif %}
      </form>
      {% endif %}

      {% if user == ticket.user %}
      <a href="#" class="btn btn-outline-danger mt-3" data-bs-toggle="modal" data-bs-target="#cancelModal">
        <i class="fas fa-times"></i> Cancel Request
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Uploaded Documents Section -->
  {% if user.role == 'S' or user.role == 'A' or user == ticket.user %}
  <div class="card shadow mb-4">
    <div class="card-header bg-light">
      <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-file-alt me-1"></i> Uploaded Documents</h6>
    </div>
    <div class="card-body">
      {% if ticket.documents.all %}
        <ul class="list-group list-group-flush">
          {% for doc in ticket.documents.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ doc.file.url }}" target="_blank">{{ doc.file.name|basename }}</a>
            <span class="badge bg-success">Uploaded by {{ doc.uploaded_by.username }}</span>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No documents uploaded yet.</p>
      {% endif %}

      <!-- Upload Form -->
      <form method="post" enctype="multipart/form-data" class="mt-3">
        {% csrf_token %}
        <div class="input-group">
          <input type="file" name="document" accept=".pdf,.jpg,.jpeg,.png,.docx" class="form-control" required>
          <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
          <button type="submit" name="action" value="upload_document" class="btn btn-outline-primary">
            <i class="fas fa-upload me-1"></i> Upload
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content">
      {% csrf_token %}
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirm Cancellation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to cancel this request?</p>
        <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button name="action" value="cancel" class="btn btn-danger">
          <i class="fas fa-times me-1"></i> Confirm Cancel
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
